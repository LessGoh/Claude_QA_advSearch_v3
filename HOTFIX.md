# HOTFIX: Multiple Issues Fixed

## Проблема 1: Pinecone Index Names
При создании личных индексов для пользователей с кириллическими именами (Стас, Макс, Вова, Семен) Pinecone возвращал ошибку:
```
INVALID_ARGUMENT: Name must consist of lower case alphanumeric characters or '-'
```

## Проблема 2: Session State Initialization
При загрузке документов возникала ошибка:
```
st.session_state has no attribute "document_metadata". Did you forget to initialize it?
```

## Решение
Добавлено сопоставление кириллических имён пользователей с ASCII-совместимыми идентификаторами для индексов:

### Изменения в `utils/auth.py`:
- Добавлен словарь `USERNAME_TO_INDEX` для сопоставления имён
- Добавлена функция `get_user_index_id()` для получения безопасного ID

```python
USERNAME_TO_INDEX = {
    "Стас": "stas",
    "Макс": "max", 
    "Вова": "vova",
    "Семен": "semen"
}
```

### Исправления Session State (app.py):
- Централизованная инициализация всех session state переменных в main app.py
- Удалена дублирующая инициализация из утилит
- Добавлены: `document_metadata`, `chat_histories`, `current_page`

### Обновлённые файлы:
- `app.py` - централизованная инициализация session state
- `utils/auth.py` - добавлено сопоставление имён
- `utils/index_manager.py` - использование безопасных ID для индексов
- `utils/navigation.py` - обновлена логика определения типа индекса
- `utils/document_manager.py` - поддержка новых имён индексов + убрана инициализация
- `utils/chat_history.py` - убрана дублирующая инициализация
- `pages/chat.py` - обновлён чат
- `pages/upload.py` - обновлена загрузка

### Схема именования индексов:
- **Личные индексы**: `pdf-qa-personal-{user_id}` (например: `pdf-qa-personal-stas`)
- **Общий индекс**: `pdf-qa-shared` (без изменений)

### Обратная совместимость:
- Пользовательский интерфейс остаётся на русском языке
- Все отображаемые имена остаются кириллическими
- Только внутренние идентификаторы индексов изменены на ASCII

## Проверка
После применения исправлений все функции должны работать корректно:
1. ✅ Вход под кириллическими именами
2. ✅ Создание личных индексов (без ошибок Pinecone)
3. ✅ Переключение между индексами
4. ✅ Загрузка документов (без ошибок session state)
5. ✅ Чат с документами
6. ✅ Управление документами и историей чата

## Deployment
Изменения готовы для деплоя в Streamlit Cloud без дополнительных настроек.